<:wrap admin/base.tmpl title=>"Manage Site Articles" :>
<:-.set refresh = cfg.admin_url("add", { "id": article.id, "tree": cgi.param("tree") }) -:>
<div class="window">
  <header>
    <h1><:param title:></h1>
    <a href="<:adminurl menu:>" accesskey="m" title="AccessKey = m" data-widget="close">Quick Launch</a>
<:include admin/include/toolbar_site.tmpl:>
  </header>
  <:- if Children:>
  <fieldset>
    <legend>Sections</legend>
    <:- if UserCan bse_edit_reorder_children:article:>
    Sort by:
    <ul class="meta group">
      <li><a href="<:adminurl reorder:>?parentid=<:article id:>&amp;sort=title&amp;r=<:script:>%3Fid=<:article id:>">title</a></li>
      <li><a href="<:adminurl reorder:>?parentid=<:article id:>&amp;sort=id&amp;r=<:script:>%3Fid=<:article id:>">date</a></li>
      <li><a href="<:adminurl reorder:>?parentid=<:article id:>&amp;sort=listed&amp;r=<:script:>%3Fid=<:article id:>">listed</a></li>
      <li><a href="<:adminurl reorder:>?parentid=<:article id:>&amp;reverse=1&amp;r=<:script:>%3Fid=<:article id:>">reverse</a></li>
      <li><:ifCgi sort:><a href="<:script:>?id=<:article id:>">advanced &times;</a><:or:><a href="<:script:>?id=<:article id:>&amp;sort=1">advanced</a><:eif:></li>
    </ul>
    <:- if Cgi sort:>
<:include admin/include/edit_article_sort.tmpl optional:>
    <:- eif Cgi:>
    <:- eif UserCan:>
    <:-.define article :>
      <:-.set indicator = [] -:>
      <:-.if article.is_expired :>
        <:-% indicator.push("red") :>
      <:-.elsif !article.is_released :>
        <:-% indicator.push("white") :>
      <:-.elsif article.listed == 0 :>
        <:-% indicator.push("gray") :>
      <:-.elsif article.listed == 1 :>
        <:-% indicator.push("green") :>
      <:-.elsif article.listed == 2 :>
        <:-% indicator.push("orange") :>
      <:-.end if:>
      <li>
        <span class="<:-= globals.odd ? " odd" : "" :>">
          <:-.set globals.odd = !globals.odd :>
          <a href="<:= article.admin :>"<:.if article.parentid != parentid :> data-widget="stepkid"<:.end if:>>
            <span class="indicator <:= indicator.join(" ") :>"></span>
            <:= article.titleAlias or article.title :><:.if article.titleAlias:> (<:= article.title :>)<:.end if:>
          </a>
          <span class="actions">
            <:-.set typename = article.generator.replace("Generate::", "") :>
            <:-.if article.parentid != parentid :>
            <a href="<:= cfg.admin_url("add", { "id": parentid, "stepkid": article.id, "_t": "steps", "r": refresh }) :>" class="button gray small">Edit</a>
            <:-.if request.user_can("bse_edit_stepkid_delete",article) and request.user_can("bse_edit_stepparent_delete",parentid) :>
            <a href="<:= cfg.admin_url("add", { "id": parentid, "stepkid": article.id, "typename": typename, "del_stepkid": 1, "_csrfp": request.get_csrf_token("admin_remove_stepkid"), "r": refresh }) :>" class="button red small" data-action="Delete" data-object="Stepchild" data-confirm="Are you sure you want to remove the Stepchild relationship?" data-info="Continuing with this action will permanently remove this Stepchild relationship. This action does not delete the original <:= typename :>.">Delete</a>
            <:-.else:>
            <a class="button red small disabled">Delete</a>
            <:-.end if:>
            <:-.else:>
            <a href="<:= cfg.admin_url("add", { "id": article.id, "r": refresh }) :>" class="button gray small">Edit</a>
            <:-.if request.user_can("bse_edit_delete_article",article) :>
            <a href="<:= cfg.admin_url("add", { "id": article.id, "remove": 1, "_csrfp": request.get_csrf_token("admin_remove_article"), "r": refresh }) :>" class="button red small" data-action="Delete" data-object="<:= typename :>" >Delete</a>
            <:-.else:>
            <a class="button red small disabled">Delete</a>
            <:-.end if:>
            <:-.end if:>
            <:-.if request.user_can("edit_reorder_children",parentid) :>
            <:-.call "move", "article": article, "parent": { "id": parentid }, "admin": 1, "r": refresh :>
            <:-.end if:>
          </span>
        </span>
      <:-# do not list children for step kids, could lead to infinite recursion :>
      <:-.if article.parentid == parentid and level < 10 and cgi.param("tree") :>
        <:-.set kids = [ article.allkids ] :>
        <:-.if kids.size :>
      <ul>
        <:-.for kid in kids:>
        <:-.call "article", "article": kid, "parentid": article.id, "level": level+1 :>
        <:-.end for:>
      </ul>
        <:-.end if:>
      <:-.end if:>
      </li>
    <:-.end define :>
    <:-.set globals.odd = 1 :>
    <ul class="inset list tree">
      <:-.set kids = [ bse.site.allkids ] :>
      <:-.for kid in kids :>
      <:-.call "article", "article": kid, "parentid": article.id, "level": 1 :>
      <:-.end for:>
    </ul>
  </fieldset>
  <:- eif Children:>
</div>